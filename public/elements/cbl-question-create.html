<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">

<link rel="import" href="cbl-app-styles.html">
<link rel="import" href="cbl-page.html">
<link rel="import" href="cbl-connections.html">

<dom-module id="cbl-question-create">
  <template>
    <style include="cbl-app-styles">
      :host {
        display: block;
        position: relative;
        min-height: calc(100vh - 64px);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }

      cbl-page {
        max-width: 400px;
        margin-bottom: 0;
      }

      .challenge {
        font-size: 12px;
        line-height: 110%;
      }

      paper-button.submit {
        margin: 32px 0 0;
      }

      cbl-connections {
        min-width: 720px;
        max-width: 800px;
      }

      @media screen and (max-width: 600px) {
        :host {
          @apply(--layout-start-justified);
        }
      }
    </style>

    <cbl-page>
      <div class="title">
        <div class="head">New Question</div>
        <div class="challenge">Challenge: <a href="/challenges/[[challenge.id]]" data-path$="/challenges/[[challenge.id]]" state="[[challenge]]" on-tap="go">[[challenge.title]]</a></div>
      </div>
      <div>Guiding questions represent the knowledge needed to successfully develop a solution and provide a map for the learning process. <a href="https://www.challengebasedlearning.org/pages/about-cbl" target="_blank">Learn more <iron-icon icon="open-in-new"></iron-icon></a></div>
      <form is="iron-form" id="form">
        <paper-input
          label="Title"
          error-message="Please enter the question's title"
          value="{{title}}"
          maxlength="128"
          on-focus="_focus"
          on-blur="_blur"
          autofocus
          required>
        </paper-input>

        <paper-textarea
          label="Description"
          value="{{description}}"
          maxlength="512"
          on-focus="_focus"
          on-blur="_blur">
        </paper-textarea>

        <paper-button class="submit" on-tap="submit" disabled="[[!title]]">Ask</paper-button>

        <button hidden></button>
      </form>
    </cbl-page>

    <cbl-connections challenge="[[challenge]]" editable></cbl-connections>

  </template>
  <script>
    Polymer({
      is: 'cbl-question-create',

      behaviors: [CBLAppBehavior],

      properties: {
        challengeId: {
          type: String
        },
        challenge: {
          type: Object
        },
        title: {
          type: String
        }
      },

      listeners: {
        'iron-form-presubmit': 'submit',
      },

      attached: function() {
        if (!this.challenge) {
          this.load();
        }
      },

      load: function() {
        if (!this.challengeId) return;
        this.loading = true;

        var self = this;

        Parse.Cloud.run('getChallenge', {id: this.challengeId}).then(function(challenge) {
          self.challenge = challenge;
        }).always(function() {
          self.loading = false;
        });
      },

      submit: function(e) {
        if (!this.challenge || !this.$.form.validate()) return;

        if (!this.user) {
          this.go('/login?back=' + this.path);
          return;
        }

        e && e.preventDefault();
        this.loading = true;

        var challenge = new Parse.Object('Challenge');
        var question = new Parse.Object('Question');
        var self = this;

        challenge.id = this.challenge.id;

        question.set('challenge', challenge);
        question.set('title', this.title);
        question.set('description', this.description);
        question.save().then(function() {
          self.message = 'Your question has been successfully registered';
          self.go('/challenges/' + self.challenge.id);
        }, function(error) {
          console.log(error);
        }).always(function() {
          self.loading = false;
        });
      },

      _focus: function(e) {
        e.target.charCounter = true;
      },

      _blur: function(e) {
        e.target.charCounter = false;
      }
    });
  </script>
</dom-module>