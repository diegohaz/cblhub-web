<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="cbl-app-styles.html">
<link rel="import" href="cbl-page.html">

<dom-module id="cbl-user-signup">
  <template>
    <style include="cbl-app-styles">
      :host {
        display: block;
        position: relative;
        min-height: calc(100vh - 64px);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }

      paper-button.submit {
        margin: 32px 0 0;
      }

      .facebook {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        padding-top: 8px;
      }

      .facebook paper-button {
        background-color: #3B5998;
      }

      @media screen and (max-width: 600px) {
        :host {
          @apply(--layout-start-justified);
        }
      }
    </style>

    <cbl-page>
      <div class="title">New Account</div>
      <form is="iron-form" id="form">
        <paper-input
          label="Display name"
          error-message="Please enter a valid name"
          value="{{displayName}}"
          minlength="3"
          required
          autofocus>
        </paper-input>

        <paper-input
          id="emailInput"
          name="email"
          type="email"
          label="E-mail"
          error-message="Please enter a valid email"
          pattern="^[a-zA-Z0-9-_\.]+@[a-zA-Z0-9-_\.]+$"
          value="{{email}}"
          required
          auto-validate>
        </paper-input>

        <paper-input
          name="email"
          type="email"
          label="Confirm e-mail"
          error-message="E-mails don't match"
          pattern="^[[email]]$"
          value="{{reEmail}}"
          required
          auto-validate>
        </paper-input>

        <paper-input
          type="password"
          label="Password"
          error-message="Please enter a password"
          value="{{password}}"
          required
          auto-validate>
        </paper-input>

        <paper-input
          type="password"
          label="Confirm password"
          error-message="Passwords don't match"
          pattern="^[[password]]$"
          value="{{rePassword}}"
          required
          auto-validate>
        </paper-input>

        <paper-button class="submit" on-tap="submit" disabled="[[_isEmpty(displayName, email, reEmail, password, rePassword)]]">Sign Up</paper-button>
        <button hidden></button>
      </form>
    </cbl-page>

      <div class="login">
        <p>Already have an account? <a href="/login">Log in</a></p>
      </div>

    <paper-toast id="toast" duration="5000" text="An error occurred. Please try again later."></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'cbl-user-signup',

      behaviors: [CBLAppBehavior],

      properties: {
        email: {
          type: String,
          notify: true
        },
        back: {
          type: String,
          value: '/'
        }
      },

      listeners: {
        'iron-form-presubmit': 'submit',
      },

      submit: function(e) {
        if (!this.$.form.validate()) return;

        e && e.preventDefault();

        this.loading = true;
        var user = new Parse.User;

        user.set('name', this.displayName);
        user.set('email', this.email);
        user.set('username', this.email);
        user.set('password', this.password);

        var self = this;

        user.signUp().then(function() {
          self.user = Parse.User.current();
          self.message = 'You have successfully signed up';
          self.go(self.back || '/');
        }, function(error) {
          if (error.code == 202) {
            self.$.emailInput.focus();
            self.$.emailInput.invalid = true;
            self.$.toast.text = 'E-mail already registered';
          }

          self.$.toast.open();
        }).always(function() {
          self.loading = false;
        });
      }
    });
  </script>
</dom-module>