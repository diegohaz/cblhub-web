<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<dom-module id="cbl-challenge-photos">
  <template>
    <style>
      :host {
        position: relative;
        display: block;
        background-color: #fff;
        width: 100%;
        box-sizing: border-box;
      }

      paper-progress {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 99;
      }

      paper-menu {
        padding: 0;
      }

      paper-menu ::content > .content {
        overflow-x: auto;
        @apply(--layout-horizontal);
      }

      paper-item {
        padding: 8px 4px;
        @apply(--layout-flex-none);
      }

      paper-item:first-child {
        padding-left: 8px;
      }

      paper-item:last-child {
        padding-right: 8px;
      }

      iron-image {
        width: 100px;
        height: 100px;
        background-color: #fff;
      }

      .footer {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        height: 56px;
      }

      .flickr {
        @apply(--layout-flex);
        margin-left: 16px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      paper-button {
        background-color: transparent;
        color: var(--primary-text-color);
      }

      .save {
        color: var(--accent-color);
      }
    </style>

    <paper-progress indeterminate hidden="[[!loading]]"></paper-progress>

    <paper-menu id="menu">
      <template is="dom-repeat" items="[[photos]]" as="photo">
        <paper-item><iron-image src="[[photo.small.src]]" preload fade sizing="cover"></iron-image></paper-item>
      </template>
    </paper-menu>

    <div class="footer">
      <div class="flickr">This product uses the Flickr API but is not endorsed or certified by Flickr.</div>
      <paper-button class="cancel" on-tap="close">Cancel</paper-button>
      <paper-button class="save" on-tap="save">Save</paper-button>
    </div>
  </template>

</dom-module>

<script>

(function() {

  Polymer({

    is: 'cbl-challenge-photos',

    properties: {
      challenge: {
        type: Object,
        observer: 'load'
      },
      photos: {
        type: Array
      },
      photo: {
        type: Object,
        notify: true
      }
    },

    listeners: {
      'iron-select': '_onIronSelect'
    },

    load: function() {
      if (!this.challenge) return;

      var self = this;

      this.loading = true;

      Parse.Cloud.run('searchPhotos', {challenge: this.challenge.id}).then(function(photos) {
        self.loading = false;
        self.photos = photos;
      }, function(error) {
        console.log(error);
      });
    },

    close: function() {
      this.hidden = true;
    },

    save: function() {
      if (!this.challenge || !this.photo) return;

      var self = this;
      var photo = new Parse.Object('Photo');

      this.loading = true;

      photo.save(this.photo).then(function(photo) {
        var challenge = new Parse.Object('Challenge');

        challenge.id = self.challenge.id;
        challenge.set('photo', photo);

        return challenge.save();
      }).then(function() {
        homeCache = {};
        searchCache = {};
        self.loading = false;
        self.close();
      }, function(error) {
        console.log(error);
      });
    },

    _onIronSelect: function() {
      this.photo = this.photos[this.$.menu.selected];
    }

  });

})();

</script>
