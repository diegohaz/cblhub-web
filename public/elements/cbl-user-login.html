<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="cbl-app-styles.html">
<link rel="import" href="cbl-page.html">

<dom-module id="cbl-user-login">
  <template>
    <style include="cbl-app-styles">
      :host {
        display: block;
        position: relative;
        min-height: calc(100vh - 64px);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }

      cbl-page {
        max-width: 400px;
      }

      paper-button.submit {
        margin: 32px 0 0;
      }

      .facebook {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        padding-top: 8px;
      }

      .facebook paper-button {
        background-color: #3B5998;
      }

      @media screen and (max-width: 600px) {
        :host {
          @apply(--layout-start-justified);
        }
      }
    </style>

    <cbl-page>
      <div class="title">Log In</div>
      <form is="iron-form" id="form">
        <paper-input
          id="emailInput"
          name="email"
          type="email"
          label="E-mail"
          error-message="Please enter a valid email"
          pattern="^[a-zA-Z0-9-_\.]+@[a-zA-Z0-9-_\.]+$"
          value="{{email}}"
          autofocus
          required
          auto-validate>
        </paper-input>

        <paper-input
          id="passwordInput"
          type="password"
          label="Password"
          error-message="Please enter a password"
          value="{{password}}"
          required
          auto-validate>
        </paper-input>

        <paper-button class="submit" on-tap="submit" disabled="[[_isEmpty(email, password)]]">Log In</paper-button>

        <button hidden></button>
      </form>
    </cbl-page>

    <div class="signup">
      <p>Forgot your password? <a href="/login/reset">Reset password</a></p>
      <p>Don't you have an account? <a href="/signup">Sign up</a></p>
    </div>

    <paper-toast id="toast" duration="5000" text="An error occurred. Please try again later."></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'cbl-user-login',

      behaviors: [CBLAppBehavior],

      properties: {
        email: {
          type: String,
          notify: true
        },
        back: {
          type: String,
          value: '/'
        }
      },

      listeners: {
        'iron-form-presubmit': 'submit',
      },

      submit: function(e) {
        if (!this.$.form.validate()) return;

        e && e.preventDefault();

        this.loading = true;
        var self = this;

        Parse.User.logIn(this.email, this.password).then(function() {
          self.user = Parse.User.current();
          self.message = 'You have successfully logged in';
          self.go(self.back || '/');
        }, function(error) {
          if (error.code == 101) {
            self.$.emailInput.focus();
            self.$.emailInput.invalid = true;
            self.$.passwordInput.invalid = true;
            self.$.toast.text = 'Wrong e-mail or password';
          }

          self.$.toast.open();
        }).always(function() {
          self.loading = false;
        });
      }
    });
  </script>
</dom-module>