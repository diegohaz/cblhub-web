<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="cbl-app-styles.html">
<link rel="import" href="cbl-page.html">

<dom-module id="cbl-user-login">
  <template>
    <style include="cbl-app-styles">
      :host {
        display: block;
        position: relative;
        min-height: calc(100vh - 64px);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }

      cbl-page {
        max-width: 400px;
      }

      .facebook {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        padding-top: 8px;
      }

      .facebook paper-button {
        background-color: #3B5998;
      }
    </style>

    <cbl-page title="Log In">
      <div class="options">
        <paper-button on-tap="submit" disabled="[[_isEmpty(email, password)]]">Log In</paper-button>
      </div>
      <form is="iron-form" id="form">
        <paper-input
          id="emailInput"
          name="email"
          type="email"
          label="E-mail"
          error-message="Please enter a valid email"
          pattern="^[a-zA-Z0-9-_\.]+@[a-zA-Z0-9-_\.]+$"
          value="{{email}}"
          autofocus
          required
          auto-validate>
        </paper-input>

        <paper-input
          id="passwordInput"
          type="password"
          label="Password"
          error-message="Please enter a password"
          value="{{password}}"
          required
          auto-validate>
        </paper-input>

        <div class="signup">
          <p>Forgot your password? <a href="/passwordreset">Reset password</a></p>
          <p>Don't you have an account? <a href="/signup">Sign up</a></p>
        </div>

        <button hidden></button>
      </form>
    </cbl-page>

<!--     <cbl-dialog id="dialog" heading="Log in" confirm-label="Log in" loading="{{loading}}" with-backdrop>
      <div class="facebook" hidden="[[mobile]]">
        <paper-button>Log in with Facebook</paper-button>
        or use your e-mail:
      </div>
      <div class="facebook" hidden="[[!mobile]]">
        or use your Facebook account:
        <paper-button>Log in with Facebook</paper-button>
      </div>
    </cbl-dialog> -->

    <paper-toast id="toast" duration="5000" text="An error occurred. Please try again later."></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'cbl-user-login',

      behaviors: [CBLAppBehavior],

      properties: {
        email: {
          type: String,
          notify: true
        },
        back: {
          type: String,
          value: '/'
        }
      },

      listeners: {
        'iron-form-presubmit': 'submit',
      },

      submit: function(e) {
        if (!this.$.form.validate()) return;

        e && e.preventDefault();

        this.loading = true;
        var self = this;

        Parse.User.logIn(this.email, this.password).then(function() {
          self.user = Parse.User.current();
          self.go((self.back || '/') + '?done=/login');
        }, function(error) {
          if (error.code == 101) {
            self.$.emailInput.focus();
            self.$.emailInput.invalid = true;
            self.$.passwordInput.invalid = true;
            self.$.toast.text = 'Wrong e-mail or password';
          }

          self.$.toast.open();
        }).always(function() {
          self.loading = false;
        });
      }
    });
  </script>
</dom-module>