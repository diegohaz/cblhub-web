<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<dom-module id="cbl-search-bar">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        border: 1px solid #bbb;
        border-radius: 4px;
        @apply(--layout-horizontal);
      }

      #searchInput {
        @apply(--paper-font-common-base);
        @apply(--layout-flex);
        position: relative;
        font-size: 16px;
        height: 39px;
        outline: none;
        box-shadow: none;
        padding: 0 8px;
        background: transparent;
        border: none;
        color: var(--paper-input-container-input-color, --primary-text-color);
        -webkit-appearance: none;
        box-sizing: border-box;
      }

      #searchInput:focus + paper-icon-button {
        background-color: var(--accent-color);
        color: var(--text-accent-color);
      }

      paper-icon-button {
        background-color: #e8e8e8;
        color: var(--primary-text-color);
        width: 60px;
        height: 39px;
        border-radius: 0 4px 4px 0;
      }

      paper-menu {
        position: absolute;
        left: 0;
        top: calc(100% + 1px);
        width: calc(100% - 60px);
        padding: 0;
        overflow-y: auto;
        @apply(--shadow-elevation-2dp);
      }

      paper-item {
        min-height: 32px;
      }

      .iron-selected{
        background: #E0E0E0;
      }
    </style>

    <input
      is="iron-input"
      id="searchInput"
      type="search"
      placeholder="Search for challenges, questions, activities and resources"
      autocomplete="off"
      bind-value="{{query}}"
      role="combobox"
      aria-label="Search"
      aria-expanded="true"
      aria-autocomplete="list"
      aria-owns="keywordsMenu"
      aria-activedescendant$="{{selected}}">

    <paper-icon-button icon="search" aria-label="Search" on-tap="submit"></paper-icon-button>

    <paper-menu id="keywordsMenu" role="listbox" attr-for-selected="id" selected="{{selected}}">
      <template is="dom-repeat" items="{{keywords}}" index-as="i">
        <paper-item id="keyword[[i]]" on-mouseover="_mouseover" on-tap="_tap">[[item]]</paper-item>
      </template>
    </paper-menu>

  </template>

</dom-module>

<script>
  Polymer({
    is: 'cbl-search-bar',

    behaviors: [CBLAppBehavior],

    properties: {
      query: {
        type: String,
        notify: true
      }
    },

    ready: function() {
      this.allKeywords = [];
      this._fetchKeywords();
      this.focused = false;
      this.$.keywordsMenu.hidden = true;

      this.$.searchInput.addEventListener('keyup', this._keyup.bind(this));
      this.$.searchInput.addEventListener('keydown', this._keydown.bind(this));
      this.$.searchInput.addEventListener('blur', this._blur.bind(this));
      this.$.searchInput.addEventListener('focus', this._focus.bind(this));
    },

    submit: function() {
      if (this.query) {
        this.go('/search/' + this.query);
      } else {
        this.go('/');
      }
    },

    _fetchKeywords: function() {
      Parse.Cloud.run('listKeywords').then(function(keywords) {
        this.allKeywords = keywords.map(function(k) {
          return k.keyword;
        });

        this._searchKeywords('');
      }.bind(this));
    },

    _focus: function() {
      this.$.keywordsMenu.hidden = false;
      this.focused = true;
    },

    _blur: function() {
      this.$.keywordsMenu.select(-1);
      this.focused = false;

      this.async(function() {
        if (!this.focused) {
          this.$.keywordsMenu.hidden = true;
        }
      }, 100);
    },

    _keydown: function(e) {
      if (e.which == 40 || e.which == 38) {
        e.preventDefault();
      }
    },

    _mouseover:function(e) {
      var searchInput = this.$.searchInput;
      var keywordsMenu = this.$.keywordsMenu;
      var selectedItem = e.currentTarget;
      var index = Number(keywordsMenu.indexOf(selectedItem));

      keywordsMenu.select('keyword' + index);
      searchInput.focus();
    },

    _tap: function(e) {
      var keywordsMenu = this.$.keywordsMenu;
      var selectedItem = e.currentTarget;
      var index = Number(keywordsMenu.indexOf(selectedItem));

      this.query = this.keywords[index];

      this.keywords = [];
      this.submit();
      e.stopPropagation();
    },

    _keyup: function(e) {
      var searchInput = this.$.searchInput;
      var keywordsMenu = this.$.keywordsMenu;
      var selectedItem = keywordsMenu.focusedItem || keywordsMenu.selectedItem;
      var index = 0;

      if (e.which == 40) {
        //down
        if (typeof selectedItem != 'undefined') {
          index = Number(keywordsMenu.indexOf(selectedItem));
          index = Math.min(index + 1, this.keywords.length - 1);
        }

        keywordsMenu.select('keyword' + index);
        searchInput.focus();
      } else if (e.which == 38) {
        //up
        if (typeof selectedItem != 'undefined') {
          index = Number(keywordsMenu.indexOf(selectedItem));
          index = Math.max(index - 1, -1);
          keywordsMenu.select('keyword' + index);
        }

        searchInput.focus();
      } else if (e.which == 13) {
        // enter
        if (typeof selectedItem != 'undefined') {
          index = Number(keywordsMenu.indexOf(selectedItem));
          this.query = this.keywords[index];
          this.keywords = [];
          keywordsMenu.select(-1);
        }
        this.submit();
      } else if (e.which == 27) {
        // esc
        if (typeof selectedItem != 'undefined') {
          keywordsMenu.select(-1);
        }
        this.keywords = [];
      } else {
        // search
        this._searchKeywords(this.query.trim());
      }
    },

    _searchKeywords: function(term) {
      this.keywords = [];

      if (term == '') {
        this.keywords = this.allKeywords.slice(0, 10);
        return;
      }

      var pattern = new RegExp(term.toLowerCase());

      for (var i = 0; i < this.allKeywords.length; i++) {
        if (this.keywords.length == 10) break;

        var keyword = this.allKeywords[i];

        if (pattern.test(keyword.toLowerCase())) {
          this.push('keywords', keyword);
        }
      }
    }

  });

</script>
