<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<dom-module id="cbl-search-bar">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      }
/*
      paper-input {
        --paper-transition-easing: {
          -webkit-transition: none;
          transition: none;
        };
      }*/

      #searchInput {
        @apply(--paper-font-common-base);
        position: relative;
        font-size: 16px;
        outline: none;
        box-shadow: none;
        padding: 0 8px;
        width: calc(100% - 60px);
        background: transparent;
        border: 1px solid #bbb;
        border-right: 0;
        border-radius: 4px 0 0 4px;
        color: var(--paper-input-container-input-color, --primary-text-color);
        -webkit-appearance: none;
        height: 40px;
      }

      paper-icon-button {
        background-color: var(--accent-color);
        color: var(--text-accent-color);
        margin-left: -5px;
        width: 60px;
        border-radius: 0 4px 4px 0;
      }

      paper-menu {
        position: absolute;
        left: 0;
        top: 100%;
        width: calc(100% - 60px);
        padding: 0;
        overflow-y: auto;
        @apply(--shadow-elevation-2dp);
      }

      paper-item {
        min-height: 32px;
      }

      .iron-selected{
        background: #E0E0E0;
      }
    </style>

<!--     <paper-input
      id="searchInput"
      label="Search for challenges, questions, activities and resources"
      value="{{query}}"
      on-keyup="_keyup"
      on-keydown="_keydown"
      on-blur="_blur"
      on-focus="_focus"
      no-label-float>
      <paper-icon-button suffix icon="search" on-tap="search"></paper-icon-button>
    </paper-input> -->

    <input
      is="iron-input"
      id="searchInput"
      type="search"
      name="search"
      placeholder="Search for challenges, questions, activities and resources"
      autocomplete="off"
      bind-value="{{query}}">

    <paper-icon-button icon="search" on-tap="search"></paper-icon-button>

    <paper-menu id="keywordsMenu">
      <template is="dom-repeat" items="{{keywords}}">
        <paper-item on-mouseover="_selection" on-tap="_select">[[item]]</paper-item>
      </template>
    </paper-menu>

  </template>

</dom-module>

<script>
  Polymer({
    is: 'cbl-search-bar',

    properties: {
      query: {
        type: String,
        notify: true
      }
    },

    ready: function() {
      this.allKeywords = [];
      this._fetchKeywords();
      this.focused = false;
      this.$.keywordsMenu.hidden = true;

      this.$.searchInput.addEventListener('keyup', this._keyup.bind(this));
      this.$.searchInput.addEventListener('keydown', this._keydown.bind(this));
      this.$.searchInput.addEventListener('blur', this._blur.bind(this));
      this.$.searchInput.addEventListener('focus', this._focus.bind(this));
    },

    _fetchKeywords: function() {
      Parse.Cloud.run('listKeywords').then(keywords => {
        this.allKeywords = keywords.map(k => k.keyword);
        this._searchKeywords('');
      });
    },

    _focus: function() {
      this.$.keywordsMenu.hidden = false;
      this.focused = true;
    },

    _blur: function() {
      this.$.keywordsMenu.select(-1);
      this.focused = false;

      this.async(() => {
        if (!this.focused) {
          this.$.keywordsMenu.hidden = true;
        }
      }, 100);
    },

    _keydown: function(e) {
      if (e.which == 40 || e.which == 38) {
        e.preventDefault();
      }
    },

    _selection:function(e) {
      let searchInput = this.$.searchInput;
      let keywordsMenu = this.$.keywordsMenu;
      let selectedItem = e.currentTarget;
      let index = Number(keywordsMenu.indexOf(selectedItem));

      keywordsMenu.select(index);
      searchInput.focus();
    },

    _select: function(e) {
      let keywordsMenu = this.$.keywordsMenu;
      let selectedItem = e.currentTarget;
      let index = Number(keywordsMenu.indexOf(selectedItem));

      this.query = this.keywords[index];

      this.keywords = [];
      e.stopPropagation();
    },

    _keyup: function(e) {
      let searchInput = this.$.searchInput;
      let keywordsMenu = this.$.keywordsMenu;
      let selectedItem = keywordsMenu.focusedItem || keywordsMenu.selectedItem;
      let index = 0;

      if (e.which == 40) {
        //down
        if (typeof selectedItem != 'undefined') {
          index = Number(keywordsMenu.indexOf(selectedItem));
          index = Math.min(index + 1, this.keywords.length - 1);
        }

        keywordsMenu.select(index);
        searchInput.focus();
      } else if (e.which == 38) {
        //up
        if (typeof selectedItem != 'undefined') {
          index = Number(keywordsMenu.indexOf(selectedItem));
          index = Math.max(index - 1, -1);
          keywordsMenu.select(index);
        }

        searchInput.focus();
      } else if (e.which == 13) {
        // enter
        if (typeof selectedItem != 'undefined') {
          index = Number(keywordsMenu.indexOf(selectedItem));
          this.query = this.keywords[index];
          this.keywords = [];
          keywordsMenu.select(-1);
        }
      } else {
        // search
        this._searchKeywords(this.query.trim());
      }
    },

    _searchKeywords: function(term) {
      this.keywords = [];

      if (term == '') {
        this.keywords = this.allKeywords.slice(0, 10);
        return;
      }

      let pattern = new RegExp(term.toLowerCase());

      for (var i = 0; i < this.allKeywords.length; i++) {
        if (this.keywords.length == 10) break;

        let keyword = this.allKeywords[i];

        if (pattern.test(keyword.toLowerCase())) {
          this.push('keywords', keyword);
        }
      }
    }

  });

</script>
