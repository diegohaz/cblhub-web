<link rel="import" href="../../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-shared-styles.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/transform-animation.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="cbl-shared-styles.html">

<dom-module id="cbl-dialog">
  <template>
    <style include="cbl-shared-styles">
      :host {
        display: block;
        min-width: 400px;
        border-radius: 5px;
        margin: 16px;
        background-color: var(--primary-background-color);
        color: var(--primary-text-color);
        @apply(--shadow-elevation-16dp);
      }

      :host > * {
        padding: 0 16px;
      }

      paper-progress {
        position: absolute;
        padding: 0;
        width: 100%;
        z-index: 100;
      }

      .toolbar {
        height: 64px;
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .toolbar h2 {
        @apply(--layout-flex);
        font-size: 20px;
        font-weight: 400;
        overflow-x: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 150%;
      }

      .content {
        max-height: calc(100vh - 160px);
        overflow: auto;
      }

      .footer {
        height: 64px;
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        @apply(--layout-center);
      }

      @media screen and (max-width: 420px) {
        :host {
          min-width: auto;
          border-radius: 0;
          position: absolute;
          overflow: hidden;
          width: 100%;
          height: 100%;
          margin: 0;
        }

        .toolbar {
          height: 56px;
          padding: 0 8px;
        }

        .toolbar h2 {
          margin-left: 16px;
        }

        .content {
          max-height: calc(100vh - 56px);
        }
      }
    </style>

    <iron-media-query query="max-width: 420px" query-matches="{{mobile}}"></iron-media-query>

    <div class="toolbar">
      <paper-icon-button on-tap="back" icon="close" hidden="[[!mobile]]"></paper-icon-button>
      <h2>[[heading]]</h2>
      <paper-button on-tap="confirm" class="bordered" hidden="[[!mobile]]">[[confirmLabel]]</paper-button>
    </div>

    <paper-progress indeterminate hidden="[[!loading]]"></paper-progress>

    <div class="content">
      <content></content>
    </div>

    <template is="dom-if" if="[[!mobile]]">
      <div class="footer">
        <paper-button class="bordered" on-tap="back">[[dismissLabel]]</paper-button>
        <paper-button on-tap="confirm">[[confirmLabel]]</paper-button>
      </div>
    </template>

  </template>
</dom-module>

<script>

(function() {

  Polymer({

    is: 'cbl-dialog',

    behaviors: [
      Polymer.CblAppBehavior,
      Polymer.PaperDialogBehavior,
      Polymer.NeonAnimationRunnerBehavior
    ],

    properties: {
      heading: {
        type: String
      },
      confirmLabel: {
        type: String,
        value: 'Save'
      },
      dismissLabel: {
        type: String,
        value: 'Cancel'
      },
      loading: {
        type: Boolean,
        value: false,
        notify: true
      }
    },

    listeners: {
      'neon-animation-finish': '_onNeonAnimationFinish',
      'iron-overlay-closed': '_onClose'
    },

    ready: function() {
      this.animationConfig = {
        'entry': [{
          name: 'transform-animation',
          node: this,
          transformFrom: 'translateY(100%)',
          transformTo: 'translateY(0)',
          timing: {duration: 250}
        }, {
          name: 'fade-in-animation',
          node: this,
          timing: {duration: 250}
        }],
        'exit': [{
          name: 'transform-animation',
          node: this,
          transformFrom: 'translateY(0%)',
          transformTo: 'translateY(100%)',
          timing: {duration: 250}
        }, {
          name: 'fade-out-animation',
          node: this,
          timing: {duration: 250}
        }]
      };
    },

    confirm: function() {
      this.fire('cbl-dialog-confirm');
    },

    _renderOpened: function() {
      if (this.withBackdrop) {
        this.backdropElement.open();
      }
      this.playAnimation('entry');
    },

    _renderClosed: function() {
      if (this.withBackdrop) {
        this.backdropElement.close();
      }
      this.playAnimation('exit');
    },

    _onNeonAnimationFinish: function() {
      if (this.opened) {
        this._finishRenderOpened();
      } else {
        this._finishRenderClosed();
      }
    },

    _onClose: function() {
      if (this.closingReason.canceled) {
        this.back();
      }
    },

    back: function() {
      if (page.params && page.params.overlay && page.params.overlay != page.current) {
        page(page.params.overlay);
      } else {
        page('/');
      }
    }

  });

})();

</script>
