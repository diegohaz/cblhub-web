<script src="../../bower_components/page/page.js"></script>
<script src="../../bower_components/moment/min/moment.min.js"></script>
<script src="../../bower_components/parse/parse.min.js"></script>
<script>
  Parse.initialize("u4Sb7tV4jOqPNqD9nouqVQMgwQwEIemuOl2GPesc", "JWQuSPOojxH8vPHyAi9yNAWtNmgVibcjwoI2EtKu");
</script>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/lazy-pages/lazy-pages.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="cbl-app-styles.html">
<link rel="import" href="cbl-app-behavior.html">
<link rel="import" href="cbl-toolbar.html">
<link rel="import" href="cbl-home.html">
<link rel="import" href="cbl-challenge-create.html">
<link rel="import" href="cbl-user-login.html">
<link rel="import" href="cbl-user-signup.html">
<link rel="import" href="cbl-challenge.html">
<link rel="import" href="cbl-question-create.html">

<dom-module id="cbl-app">
  <template>
    <style include="cbl-app-styles">
      :host {
        display: block;
        @apply(--layout-fit);
        @apply(--layout-vertical);
      }

      lazy-pages {
        transform: translateZ(0);
        overflow: visible;
      }

      paper-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 999;
      }
    </style>
    <iron-media-query query="max-width: 600px" query-matches="{{mobile}}"></iron-media-query>
    <paper-progress indeterminate hidden="[[!loading]]"></paper-progress>

    <paper-scroll-header-panel id="panel" class="flex">
      <cbl-toolbar user="{{user}}" query="[[params.query]]" message="{{message}}" hidden="[[_computeHiddenToolbar(page, mobile)]]" class="paper-header"></cbl-toolbar>
      <lazy-pages selected="[[page]]" attr-for-selected="data-page">

        <template is="dom-if" data-page="/">
          <cbl-home
            query="[[params.query]]"
            tab="{{tab}}"
            message="{{message}}"
            loading="{{loading}}">
          </cbl-home>
        </template>

        <template is="dom-if" data-page="/challenges/create">
          <cbl-challenge-create
            user="[[user]]"
            message="{{message}}"
            loading="{{loading}}">
          </cbl-challenge-create>
        </template>

        <template is="dom-if" data-page="/challenge" restamp>
          <cbl-challenge
            user="[[user]]"
            message="{{message}}"
            challenge-id="[[params.challengeId]]"
            challenge="[[state.challenge]]"
            loading="{{loading}}">
          </cbl-challenge>
        </template>

        <template is="dom-if" data-page="/questions/create" restamp>
          <cbl-question-create
            user="[[user]]"
            message="{{message}}"
            challenge-id="[[params.challengeId]]"
            challenge="[[state.challenge]]"
            title="[[params.title]]"
            loading="{{loading}}">
          </cbl-question-create>
        </template>

        <template is="dom-if" data-page="/login" restamp>
          <cbl-user-login
            user="{{user}}"
            message="{{message}}"
            email="{{email}}"
            back="[[params.back]]"
            loading="{{loading}}">
          </cbl-user-login>
        </template>

        <template is="dom-if" data-page="/signup" restamp>
          <cbl-user-signup
            user="{{user}}"
            message="{{message}}"
            email="{{email}}"
            back="[[params.back]]"
            loading="{{loading}}">
          </cbl-user-signup>
        </template>

      </lazy-pages>
    </paper-scroll-header-panel>

    <paper-toast id="toast"></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'cbl-app',

      behaviors: [CBLAppBehavior],

      properties: {
        page: {
          type: String,
          notify: true
        },
        tab: {
          type: Number,
          value: 0
        },
        state: {
          type: Object,
          value: {}
        },
        params: {
          type: Object,
          value: {}
        },
        message: {
          type: String,
          observer: 'showMessage'
        },
      },

      listeners: {
        'cbl-challenge-card-tap': '_onChallengeCardTap'
      },

      homeScroll: 0,
      searchScroll: {},

      ready: function() {
        var self = this;

        // routing
        page('*', function(ctx, next) {
          if (ctx.querystring) {
            var params = ctx.querystring.split('&').map(function(q) {
              return q.split('=');
            });

            params.forEach(function(p) {
              self.set('params.' + p[0], p[1]);
            });
          }

          next();

          for (var param in ctx.params) {
            if (typeof param == 'string') {
              self.set('params.' + param, ctx.params[param]);
            }
          }

          self.page = ctx.params.page;
        });

        // home
        page(':page(/)', function() {
          self.set('params.query', undefined);

          self.async(function() {
            self.$.panel.scroller.scrollTop = self.homeScroll? self.homeScroll : 0;
          }, 20);
        });

        page.exit('/', function(ctx, next) {
          self.homeScroll = self.$.panel.scroller.scrollTop;
          next();
        });

        // search
        page(':page(/)search/:query', function(ctx) {
          var scrollTop = self.searchScroll[ctx.params.query];

          self.async(function() {
            self.$.panel.scroller.scrollTop = scrollTop? scrollTop : 0;
          }, 20);
        });

        page.exit('/search/:query', function(ctx, next) {
          self.searchScroll[ctx.params.query] = self.$.panel.scroller.scrollTop;
          next();
        });

        // login
        page(':page(/login)', function() {
          if (self.user) page('/');
        });

        // sign up
        page(':page(/signup)', function() {
          if (self.user) page('/');
        });

        // login reset
        page(':page(/login/reset)', function() {
          if (self.user) page('/');
        });

        // challenge create
        page(':page(/challenges/create)', function() {});

        // challenge view
        page(':page(/challenge)s/:challengeId', function(ctx) {
          self.$.panel.scroller.scrollTop = 0;

          if (ctx.state.bigIdea) {
            self.set('state.challenge', ctx.state);
          }
        });

        // question create
        page('/challenges/:challengeId:page(/questions/create)/:title?', function(ctx) {
          if (ctx.state.bigIdea) {
            self.set('state.challenge', ctx.state);
          }
        });

        page();
      },

      attached: function() {
        document.querySelector('body').classList.add('cbl-app-attached');
      },

      showMessage: function() {
        if (this.message) {
          this.$.toast.text = this.message;
          this.$.toast.show();
        }
      },

      _onChallengeCardTap: function(e) {
        this.challenge = e.detail;
      },

      _computeHiddenToolbar: function(page, mobile) {
        return page != '/' && mobile;
      }
    });
  </script>
</dom-module>