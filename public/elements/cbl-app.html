<script src="../../bower_components/page/page.js"></script>
<script src="../../bower_components/moment/min/moment.min.js"></script>
<script src="../../bower_components/parse/parse.min.js"></script>
<script>
  Parse.initialize("u4Sb7tV4jOqPNqD9nouqVQMgwQwEIemuOl2GPesc", "JWQuSPOojxH8vPHyAi9yNAWtNmgVibcjwoI2EtKu");
</script>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/lazy-pages/lazy-pages.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="cbl-app-styles.html">
<link rel="import" href="cbl-app-behavior.html">
<link rel="import" href="cbl-layout.html">
<link rel="import" href="cbl-home.html">
<link rel="import" href="cbl-challenge-create.html">
<link rel="import" href="cbl-user-login.html">
<link rel="import" href="cbl-user-signup.html">

<dom-module id="cbl-app">
  <template>
    <style include="cbl-app-styles">
      :host {
        display: block;
        @apply(--layout-fit);
      }

      lazy-pages {
        position: static;
        overflow: auto;
      }

      cbl-layout ::content #contentContainer {
        overflow-y: visible;
      }

      cbl-layout ::content #contentContainer .content {
        position: relative;
      }

      paper-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 999;
      }
    </style>
    <paper-progress indeterminate hidden="[[!loading]]"></paper-progress>

    <cbl-layout id="layout" path="[[path]]" query="[[params.q]]" user="{{user}}" loading="{{loading}}">
      <lazy-pages selected="[[path]]" attr-for-selected="data-path">

        <template is="dom-if" data-path="/" restamp>
          <cbl-home path="[[path]]" query="[[params.q]]" loading="{{loading}}"></cbl-home>
        </template>

        <template is="dom-if" data-path="/challenges/create">
          <cbl-challenge-create path="[[path]]" user="[[user]]" loading="{{loading}}"></cbl-challenge-create>
        </template>

        <template is="dom-if" data-path="/login" restamp>
          <cbl-user-login path="[[path]]" user="{{user}}" email="{{email}}" back="[[params.back]]" loading="{{loading}}"></cbl-user-login>
        </template>

        <template is="dom-if" data-path="/signup" restamp>
          <cbl-user-signup path="[[path]]" user="{{user}}" email="{{email}}" back="[[params.back]]" loading="{{loading}}"></cbl-user-signup>
        </template>

      </lazy-pages>
    </cbl-layout>

    <paper-toast id="toast"></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'cbl-app',

      behaviors: [CBLAppBehavior],

      properties: {
        path: {
          type: String,
          notify: true,
          value: ''
        },
        params: {
          type: Object,
          value: {}
        }
      },

      ready: function() {
        var self = this;

        // routing
        page('*', function(ctx, next) {
          var params = ctx.querystring.split('&').map(function(q) {
            return q.split('=');
          });

          self.set('params', {});

          params.forEach(function(p) {
            self.set('params.' + p[0], p[1]);
          });

          page.params = self.params;

          // remove querystring, hash
          self.path = page.current.replace(/(\?|#).*$/, '');

          if (self.params.done) {
            self.done(self.params.done);
            self.params.done = undefined;
            page(self.path || '/');
          }

          next();
        });

        page('/', function() {});

        page('/login', function() {
          if (self.user) page('/');
        });

        page('/signup', function() {
          if (self.user) page('/');
        });

        page('/passwordreset', function() {
          if (self.user) page('/');
        });

        page('/challenges/create', function() {});

        page();
      },

      attached: function() {
        document.querySelector('body').classList.add('cbl-app-attached');
      },

      done: function(action) {
        if (action == 'logout') {
          this.$.toast.text = 'You have successfully logged out';
        } else if (action == '/login') {
          this.$.toast.text = 'You have successfully logged in';
        } else if (action == '/signup') {
          this.$.toast.text = 'You have successfully signed up';
        } else if (action == '/challenges/create') {
          this.$.toast.text = 'You have successfully created a challenge';
        }

        this.$.toast.show();
      },

      _computeQuery: function(query) {
        return query || '';
      }
    });
  </script>
</dom-module>