
<script src="../../bower_components/parse/parse.min.js"></script>
<script src="../../bower_components/page/page.js"></script>
<script src="../../bower_components/underscore/underscore-min.js"></script>
<script>
  Parse.initialize("u4Sb7tV4jOqPNqD9nouqVQMgwQwEIemuOl2GPesc", "JWQuSPOojxH8vPHyAi9yNAWtNmgVibcjwoI2EtKu");
</script>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/font-roboto/roboto.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="cbl-shared-styles.html">
<link rel="import" href="cbl-layout.html">
<link rel="import" href="cbl-login-dialog.html">
<link rel="import" href="cbl-signup-dialog.html">
<link rel="import" href="cbl-challenge-dialog.html">

<dom-module id="cbl-app">
  <template>
    <style include="cbl-shared-styles">
      :host {
        display: block;
        @apply(--layout-fit);
      }
    </style>
    <iron-media-query query="min-width: 640px" query-matches="{{largeScreen}}"></iron-media-query>

    <cbl-layout user="{{user}}">
      paper-indsa
    </cbl-layout>

    <cbl-login-dialog id="loginDialog" user="{{user}}" email="{{email}}"></cbl-login-dialog>
    <cbl-signup-dialog id="signUpDialog" user="{{user}}" email="{{email}}"></cbl-signup-dialog>
    <cbl-challenge-dialog id="challengeDialog" user="{{user}}"></cbl-challenge-dialog>
  </template>
  <script>
    class App {
      beforeRegister() {
        this.is = 'cbl-app';
      }

      ready() {
        // routing
        page('*', (ctx, next) => {
          let params = ctx.querystring.split('&').map(q => q.split('='));
          page.params = page.params || {};

          params.forEach(p => {
            page.params[p[0]] = p[1];
          });

          next();
        });

        page('/', () => {

        });

        page('/login', () => {
          if (this.user) return page.back();

          this.async(() => {
            this.$.loginDialog.open();
          }, 1);
        });

        page.exit('/login', (ctx, next) => {
          next();

          this.async(() => {
            this.$.loginDialog.close();
          }, 1);
        });

        page('/signup', () => {
          if (this.user) return page.back();

          this.async(() => {
            this.$.signUpDialog.open();
          }, 1);
        });

        page.exit('/signup', (ctx, next) => {
          next();

          this.async(() => {
            this.$.signUpDialog.close();
          }, 1);
        });

        page('/challenges/create', () => {
          this.async(() => {
            this.$.challengeDialog.open();
          }, 1);
        });

        page.exit('/challenges/create', (ctx, next) => {
          next();

          this.async(() => {
            this.$.challengeDialog.close();
          }, 1);
        });

        page();
      }
    }

    Polymer(App);
  </script>
</dom-module>