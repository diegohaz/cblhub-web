<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="cbl-app-styles.html">
<link rel="import" href="cbl-app-behavior.html">
<link rel="import" href="cbl-icons.html">
<link rel="import" href="cbl-grid.html">
<link rel="import" href="cbl-challenge-card.html">

<dom-module id="cbl-home">
  <template>
    <style include="cbl-app-styles">
      :host {
        display: block;
        position: relative;
        --paper-tab-content: {
          font-weight: inherit !important;
        };
      }

      paper-tabs {
        margin-top: 16px;
        text-align: center;
      }

      paper-tabs ::content #tabsContent {
        position: static !important;
      }

      paper-tab iron-icon {
        margin-right: 8px;
        color: var(--accent-color);
      }

      cbl-grid {
        margin-top: 12px !important;
        margin-bottom: 12px !important;
        margin-left: 7%;
        margin-right: 7%;
      }

      cbl-grid > * {
        width: calc((100% - 8px) / 7 - 8px);
        margin: 12px;
      }

      paper-tab span {
        text-transform: uppercase;
      }

      @media screen and (max-width: 2200px) {
        cbl-grid > * { width: calc(100% / 5 - 24px); }
      }

      @media screen and (max-width: 1800px) {
        cbl-grid > * { width: calc(100% / 4 - 24px); }
      }

      @media screen and (max-width: 1400px) {
        cbl-grid > * { width: calc(100% / 3 - 24px); }
      }

      @media screen and (max-width: 1200px) {
        cbl-grid { margin: 0 12px; }
      }

      @media screen and (max-width: 1000px) {
        cbl-grid > * { width: calc(100% / 2 - 24px); }
      }

      @media screen and (max-width: 600px) {
        cbl-grid { margin: 4px !important; }

        paper-tab span { display: none; }

        cbl-grid > * {
          width: calc(100% - 8px);
          margin: 4px;
        }
      }
    </style>

    <iron-media-query query="max-width: 600px" query-matches="{{mobile}}"></iron-media-query>

    <paper-tabs selected="{{tab}}" hide-scroll-buttons noink scrollable>
      <template is="dom-repeat" items="[[tabs]]" as="label">
        <paper-tab><iron-icon icon="cbl:[[label.id]]"></iron-icon> <span>[[label.title]]</span></paper-tab>
      </template>
    </paper-tabs>

    <cbl-grid id="grid">
      <template is="dom-if" if="[[_isTab(tab, 'challenge')]]">
        <template is="dom-repeat" items="[[items]]">
          <cbl-challenge-card challenge="[[item]]"></cbl-challenge-card>
        </template>
      </template>
    </cbl-grid>

  </template>
  <script>
    var homeCache = {};
    var searchCache = {};

    Polymer({
      is: 'cbl-home',

      behaviors: [CBLAppBehavior],

      properties: {
        tabs: {
          type: Array,
          value: [
            {id: 'challenge', title: 'Challenges'},
            {id: 'question', title: 'Questions'},
            {id: 'activity', title: 'Activities'},
            {id: 'resource', title: 'Resources'}
          ]
        },
        tab: {
          type: Number,
          notify: true,
          value: 0
        },
        page: {
          type: String,
          value: 0
        },
        query: {
          type: String,
          observer: 'load'
        },
        items: Array,
      },

      observers: [
        'load(tab, page)'
      ],

      arrange: function() {
        this.$.grid.arrange();
      },

      load: function() {
        if (this.tab === undefined) return;

        var tab = this.tabs[this.tab].id;
        var queryCache = searchCache[this.query];
        var tabCache = homeCache[this.tab];

        if (this.query && queryCache && queryCache[tab] && queryCache[tab][this.page]) {
          this.items = queryCache[tab][this.page];
          this.arrange();
        } else if (!this.query && homeCache && homeCache[tab] && homeCache[tab][this.page]) {
          this.items = homeCache[tab][this.page];
          this.arrange();
        } else {
          this.cancelAsync(this.loadTask);
          this.loadTask = this.async(this._load, 100);
        }
      },

      _load: function() {
        var self = this;
        var tab = this.tabs[this.tab];
        var params = {};

        this.items = [];
        this.loading = true;

        params.keywords = this.query? [this.query] : undefined;
        params.page = this.page;

        Parse.Cloud.run('list' + tab.title, params).then(function(items) {
          if (self.query) {
            if (!searchCache[self.query]) searchCache[self.query] = {};
            if (!searchCache[self.query][tab.id]) searchCache[self.query][tab.id] = [];

            searchCache[self.query][tab.id][self.page] = items;
          } else {
            if (!homeCache[tab.id]) homeCache[tab.id] = [];

            homeCache[tab.id][self.page] = items;
          }

          self.items = self.page > 1 ? self.items.concat(items) : items;
          self.arrange();
        }, function(error) {
          console.log(error);
        }).always(function() {
          self.loading = false;
        });
      },

      _isTab: function(tab, id) {
        return this.tabs[tab].id == id;
      }
    });


  </script>
</dom-module>