<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="cbl-app-styles.html">
<link rel="import" href="cbl-app-behavior.html">
<link rel="import" href="cbl-page.html">

<dom-module id="cbl-challenge-create">
  <template>
    <style include="cbl-app-styles">
      :host {
        display: block;
        position: relative;
        min-height: calc(100vh - 64px);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }

      .notice {
        margin-top: 48px;
        margin-bottom: -16px;
      }
    </style>

    <cbl-page title="New Challenge">
      <div class="options">
        <paper-button on-tap="submit" disabled="[[_isEmpty(bigIdea, essentialQuestion, challenge)]]">Create</paper-button>
      </div>
      <form is="iron-form" id="form">
        <paper-input
          id="bigIdeaInput"
          label="Big Idea"
          error-message="Please enter the Big Idea"
          value="{{bigIdea}}"
          on-focus="_focus"
          on-blur="_blur"
          maxlength="48"
          autofocus
          required>
        </paper-input>

        <iron-collapse id="bigIdeaTip">
          <p class="tip">The big idea is a broad concept that can be explored in multiple ways, e.g. <strong>Resilience</strong>, <strong>Separation</strong>, <strong>Creativity</strong>, <strong>Health</strong>, <strong>Sustainability</strong>, <strong>Democracy</strong> etc. <a href="https://www.challengebasedlearning.org/pages/about-cbl" tabindex="4" target="_blank">Learn more <iron-icon icon="open-in-new"></iron-icon></a></p>
        </iron-collapse>

        <paper-input
          id="essentialQuestionInput"
          label="Essential Question"
          error-message="Please enter the Essential Question"
          value="{{essentialQuestion}}"
          on-focus="_focus"
          on-blur="_blur"
          maxlength="96"
          required>
        </paper-input>

        <iron-collapse id="essentialQuestionTip">
          <p class="tip">By design, the big idea allows for the generation of a wide variety of essential questions. Eventually the process narrows to one essential question that reflects the interests of the learners and the needs of their community. <a href="https://www.challengebasedlearning.org/pages/about-cbl" tabindex="4" target="_blank">Learn more <iron-icon icon="open-in-new"></iron-icon></a></p>
        </iron-collapse>

        <paper-input
          id="challengeInput"
          label="The Challenge"
          error-message="Please enter the Challenge"
          value="{{challenge}}"
          on-focus="_focus"
          on-blur="_blur"
          maxlength="96"
          required>
        </paper-input>

        <iron-collapse id="challengeTip">
          <p class="tip">From the essential question a concise challenge is articulated that asks the learners to create a specific solution that will result in concrete, meaningful action. <a href="https://www.challengebasedlearning.org/pages/about-cbl" tabindex="4" target="_blank">Learn more <iron-icon icon="open-in-new"></iron-icon></a></p>
        </iron-collapse>

        <paper-textarea
          id="descriptionInput"
          label="Description"
          value="{{description}}"
          maxlength="512"
          on-focus="_focus"
          on-blur="_blur">
        </paper-textarea>

        <iron-collapse id="descriptionTip">
          <p class="tip">Summarize the challenge, so people can understand the feelings behind it. Links are allowed. (Optional)</p>
        </iron-collapse>

        <button hidden></button>
      </form>

      <div class="notice"><iron-icon icon="language"></iron-icon> For a better experience, please write in English.</div>
    </cbl-page>

    <paper-toast id="toast" duration="5000" text="An error occurred. Please try again later."></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'cbl-challenge-create',

      behaviors: [CBLAppBehavior],

      listeners: {
        'iron-form-presubmit': 'submit',
      },

      submit: function(e) {
        e && e.preventDefault();

        if (!this.$.form.validate() || this.loading) return;

        if (!this.user) {
          this.go('/login?back=/challenges/create');
          return;
        }

        this.loading = true;
        var challenge = new Parse.Object('Challenge');

        challenge.set('title', this.challenge);
        challenge.set('description', this.description);
        challenge.set('bigIdea', this.bigIdea);
        challenge.set('essentialQuestion', this.essentialQuestion);

        var self = this;

        challenge.save().then(function(challenge) {
          self.go('/challenges/' + challenge.id);
        }, function(error) {
          self.$.toast.open();
        }).always(function() {
          self.loading = false;
        });
      },

      _focus: function(e) {
        var input = e.target;
        var tip = this.$[input.id.replace('Input', 'Tip')];

        input.charCounter = true;
        tip.show();
      },

      _blur: function(e) {
        var input = e.target;
        var tip = this.$[input.id.replace('Input', 'Tip')];

        input.charCounter = false;
        tip.hide();
      },
    });
  </script>
</dom-module>