<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">

<link rel="import" href="cbl-app-behavior.html">
<link rel="import" href="cbl-app-styles.html">
<link rel="import" href="cbl-challenge-photos.html">

<dom-module id="cbl-challenge-header">
  <template>
    <style include="cbl-app-styles">
      :host {
        display: block;
      }

      .header {
        position: relative;
        height: 400px;
        color: #fff;
      }

      .photo iron-image {
        @apply(--layout-fit);
        background-color: #212121;
      }

      .photo iron-image:before {
        content: '';
        background-image: linear-gradient(to bottom, rgba(0,0,0,.7), rgba(0,0,0,0) 64px, rgba(0,0,0,0) 35%, rgba(0,0,0,.9));
        @apply(--layout-fit);
      }

      .photo .attribution {
        position: absolute;
        bottom: 0;
        right: 0;
        padding: 8px;
        background-color: rgba(0, 0, 0, .7);
        color: rgba(255,255,255,.7);
        font-size: 12px;
        opacity: 0.6;
      }

      .photo .attribution a {
        color: #fff;
      }

      .toolbar {
        padding: 8px;
        height: 56px;
        box-sizing: border-box;
        @apply(--layout-horizontal);
      }

      .toolbar paper-button {
        background-color: transparent;
      }

      .toolbar paper-icon-button {
        color: #fff;
        --paper-icon-button-ink-color: #fff;
      }

      .ask {
        position: relative;
        width: 50%;
        min-width: 280px;
        height: 40px;
        margin: 112px auto 0;
        text-align: center;
      }

      .ask input {
        @apply(--layout-flex);
        height: 100%;
        width: 100%;
        position: relative;
        font-size: 16px;
        outline: none;
        box-shadow: none;
        padding: 0 8px;
        border: none;
        border-radius: 4px;
        color: var(--paper-input-container-input-color, --primary-text-color);
        -webkit-appearance: none;
        box-sizing: border-box;
      }

      .info {
        position: absolute;
        width: 100%;
        padding: 16px;
        bottom: 32px;
        box-sizing: border-box;
      }

      .info .title h2 {
        font-size: 32px;
        font-weight: 400;
        line-height: 1;
        text-align: center;
        margin: .3em 0;
      }

      .info .meta {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }

      .info .meta > * {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        overflow: hidden;
        white-space: nowrap;
      }

      .info .meta a {
        color: #fff;
        font-weight: 700;
      }

      .info .meta > *:not(:first-child):before {
        content: '';
        width: 12px;
        height: 1px;
        margin: 0 12px;
        background-color: rgba(255,255,255,.3);
      }

      .info .meta > * > *:first-child + * {
        margin-left: 6px;
      }

      .info .meta > * iron-icon {
        width: 20px;
        height: 20px;
        color: rgba(255,255,255,.75);
      }

      .info .meta .user iron-image {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 1px solid rgba(255,255,255,.5);
        @apply(--layout-flex-none);
      }
    </style>

    <cbl-challenge-photos id="photos" photo="{{challenge.photo}}" hidden></cbl-challenge-photos>

    <div class="header">

      <div class="photo">
        <iron-image src="[[_computePhoto(challenge.photo)]]" preload fade sizing="cover"></iron-image>
        <div class="attribution">photo by <a href="[[challenge.photo.url]]" target="_blank">[[challenge.photo.owner]]</a></div>
      </div>

      <div class="toolbar">
        <paper-icon-button icon="arrow-back" aria-label="Back" on-tap="back"></paper-icon-button>
        <div class="flex"></div>

        <template is="dom-if" if="[[!mobile]]">
          <paper-button on-tap="_togglePhotos" hidden="[[!isAuthor]]">
            <iron-icon icon="perm-media"></iron-icon>
            <span>Change photo</span>
          </paper-button>
        </template>

        <template is="dom-if" if="[[mobile]]">
          <paper-icon-button on-tap="_togglePhotos" icon="perm-media" aria-label="Change photo" hidden="[[!isAuthor]]"></paper-icon-button>
        </template>
      </div>

      <div class="ask">
        <input is="iron-input" placeholder="Have a question about this challenge? Ask here." bind-value="{{question}}">
      </div>

      <div class="info" hidden="[[!challenge]]">
        <div class="title">
          <h2>[[challenge.title]]</h2>
        </div>
        <div class="meta" hidden="[[mobile]]">
          <div class="user">
            <iron-image src="[[challenge.user.picture]]" sizing="cover"></iron-image>
            <span>[[challenge.user.name]]</span>
          </div>
          <div class="date">
            <iron-icon icon="schedule"></iron-icon>
            <span>[[_computeDate(challenge)]]</span>
          </div>
          <div class="contributions">
            <iron-icon icon="cbl:contributions"></iron-icon>
            <span><a href="#contributions">[[_computeContributions(challenge)]]</a> [[_computeByContributors(challenge)]] <a href="#contributors">[[_computeContributors(challenge)]]</a></span>
          </div>
        </div>
      </div>

    </div>

  </template>
  <script>
    Polymer({
      is: 'cbl-challenge-header',

      behaviors: [CBLAppBehavior],

      properties: {
        challenge: {
          type: Object
        },
        mobile: {
          type: Boolean,
          value: false
        },
        isAuthor: {
          type: Boolean,
          value: false
        }
      },

      _togglePhotos: function() {
        if (this.$.photos.hidden) {
          this.$.photos.hidden = false;
          this.$.photos.challenge = this.challenge;
        } else {
          this.$.photos.hidden = true;
        }
      },

      _computePhoto: function(photo) {
        if (!photo || !photo.medium) return;

        if (photo.large.src) {
          return photo.large.src;
        } else {
          return photo.medium.src;
        }
      },

      _computeDate: function(challenge) {
        if (!challenge || !challenge.createdAt) return;

        if (challenge.updatedAt.getTime() == challenge.createdAt.getTime()) {
          return 'created ' + moment(challenge.createdAt).fromNow();
        } else {
          return 'updated ' + moment(challenge.updatedAt).fromNow();
        }
      },

      _getNumberOfContributions: function(challenge) {
        if (!challenge || challenge.questions === undefined) return;

        var types = ['questions', 'activities', 'resources'];

        var count = types.map(function(type) {
          return challenge[type].length || challenge[type];
        }).reduce(function(prev, curr) {
          return prev + curr;
        });

        return count;
      },

      _getNumberOfContributors: function(contributors) {
        return contributors.length || contributors || 0;
      },

      _computeContributions: function(challenge) {
        if (!challenge || challenge.questions === undefined) return;

        var count = this._getNumberOfContributions(challenge);

        return count > 1 ? '' + count + 'contributions' : (count ? '1 contribution' : 'no contributions yet');
      },

      _computeByContributors: function(challenge) {
        if (!challenge || challenge.contributors === undefined) return;

        var contributionsCount = this._getNumberOfContributions(challenge);
        var count = this._getNumberOfContributors(challenge.contributors);

        return count && contributionsCount ? 'by' : '';
      },

      _computeContributors: function(challenge) {
        if (!challenge || challenge.contributors === undefined) return;

        var count = this._getNumberOfContributors(challenge.contributors);

        return count > 1 ? '' + count + 'people' : (count ? '1 person' : '');
      },
    });
  </script>
</dom-module>