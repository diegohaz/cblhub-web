<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="cbl-shared-styles.html">
<link rel="import" href="cbl-dialog.html">

<dom-module id="cbl-signup-dialog">
  <template>
    <style include="cbl-shared-styles">
      :host {
        display: block;
      }

      .facebook {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        padding-top: 8px;
      }

      .facebook paper-button {
        background-color: #3B5998;
      }

      form {
        padding-bottom: 16px;
      }
    </style>

    <iron-media-query query="max-width: 420px" query-matches="{{mobile}}"></iron-media-query>

    <cbl-dialog id="dialog" heading="Create Account" confirm-label="Sign up" loading="{{loading}}" with-backdrop>
      <div class="facebook" hidden="[[mobile]]">
        <paper-button>Log in with Facebook</paper-button>
        or use your e-mail:
      </div>
      <form is="iron-form" id="form">
        <paper-input
          label="Display name"
          error-message="Please enter a valid name"
          value="{{displayName}}"
          minlength="3"
          required
          autofocus>
        </paper-input>

        <paper-input
          id="emailInput"
          name="email"
          type="email"
          label="E-mail"
          error-message="Please enter a valid email"
          pattern="^[a-zA-Z0-9-_\.]+@[a-zA-Z0-9-_\.]+$"
          value="{{email}}"
          required
          auto-validate>
        </paper-input>

        <paper-input
          name="email"
          type="email"
          label="Confirm e-mail"
          error-message="E-mails don't match"
          pattern="^[[email]]$"
          required
          auto-validate>
        </paper-input>

        <paper-input
          type="password"
          label="Password"
          error-message="Please enter a password"
          value="{{password}}"
          required
          auto-validate>
        </paper-input>

        <paper-input
          type="password"
          label="Confirm password"
          error-message="Passwords don't match"
          pattern="^[[password]]$"
          required
          auto-validate>
        </paper-input>

        <button hidden></button>
      </form>
      <p>Already have an account? <a href="/login">Log in</a>.</p>
      <div class="facebook" hidden="[[!mobile]]">
        or use your Facebook account:
        <paper-button>Log in with Facebook</paper-button>
      </div>
    </cbl-dialog>

    <paper-toast id="toast" duration="5000" text="An error occurred. Try again later."></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'cbl-signup-dialog',

      behaviors: [CBLAppBehavior],

      properties: {
        email: {
          type: String,
          notify: true
        }
      },

      listeners: {
        'iron-form-presubmit': 'submit',
        'cbl-dialog-confirm': 'submit'
      },

      submit: function(event) {
        if (!this.$.form.validate()) return;

        event && event.preventDefault();

        this.loading = true;
        let user = new Parse.User;

        user.set('name', this.displayName);
        user.set('email', this.email);
        user.set('username', this.email);
        user.set('password', this.password);

        user.signUp().then(() => {
          this.user = Parse.User.current();
          this.$.dialog.cancel();
        }, error => {
          if (error.code == 202) {
            this.$.emailInput.focus();
            this.$.emailInput.invalid = true;
            this.$.toast.text = 'E-mail already registered';
          }

          this.$.toast.open();
        }).always(() => {
          this.loading = false;
        });
      },

      open: function() {
        this.$.dialog.open();
      },

      close: function() {
        this.$.dialog.close();
      }
    });
  </script>
</dom-module>