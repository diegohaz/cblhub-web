<link rel="import" href="../../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../bower_components/neon-animation/animations/cascaded-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-in-animation.html">

<dom-module id="cbl-grid">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      }

      :host ::content > * {
        position: absolute;
      }
    </style>
    <content></content>
  </template>
  <script>
    Polymer({
      is: 'cbl-grid',

      attached: function() {
        this.async(function() {
          this.arrange();
        }, 1);

        window.addEventListener('resize', function() {
          this.arrange();
        }.bind(this));
      },

      arrange: function() {
        Polymer.dom.flush();

        var container = Polymer.dom(this).node;
        var items = container.children;

        var margin = function(name, item) {
          var style = window.getComputedStyle(item);

          return parseFloat(style['margin' + name]) || 0;
        };

        var sort = function(list) {
          list = list.sort(function(a, b) {
            return bottom(a) === bottom(b)? x(b) - x(a) : bottom(b) - bottom(a);
          });
        };

        var px      = function(n)    { return n + 'px' }
        var y       = function(item) { return parseFloat(item.style.top) }
        var x       = function(item) { return parseFloat(item.style.left) }
        var width   = function(item) { return item.clientWidth }
        var height  = function(item) { return item.clientHeight }
        var bottom  = function(item) { return y(item) + height(item) + margin('Bottom', item) }
        var right   = function(item) { return x(item) + width(item) + margin('Right', item) }

        var boundary = [];

        // First item
        if (items.length) {
          items[0].style.top = 0;
          items[0].style.left = 0;
          boundary.push(items[0]);
        }

        // First line
        for (var i = 1; i < items.length; i++) {
          var prev = items[i - 1];
          var item = items[i];
          var hasSpace = right(prev) + width(item) <= width(container);

          if (!hasSpace) break;

          item.style.top = prev.style.top;
          item.style.left = px(right(prev) + margin('Left', item));
          boundary.push(item);
        }

        // Place following elements at the bottom of the smallest column.
        for (; i < items.length; i++) {
          sort(boundary);
          var item = items[i];
          var minItem = boundary.pop();

          item.style.top = px(bottom(minItem) + margin('Top', item));
          item.style.left = px(x(minItem));
          boundary.push(item);
        };

        sort(boundary);

        var maxItem = boundary[0];
        container.style.height = px(bottom(maxItem) + margin('Bottom', maxItem));
      }
    });
  </script>
</dom-module>